PROJECT(cview)
CMAKE_MINIMUM_REQUIRED(VERSION 2.4.5)
MARK_AS_ADVANCED(CMAKE_BACKWARDS_COMPATIBILITY)
include(CheckFunctionExists)
include(CheckIncludeFile)

SET(VERSION_MAJOR 0)
SET(VERSION_MINOR 3)
SET(VERSION_PATCH 0)
SET(VERSION ${VERSION_MAJOR}.${VERSION_MINOR}.${VERSION_PATCH})
#options
OPTION(CVIEW_TEST_BUILD "Build CView Testing Applications" OFF)
OPTION(GCOBJECTDEBUG "Enable Tracking of Object Allocations" OFF)
OPTION(BUILD_DOCS "Build the cview documentaion" OFF)
#deal with tweakbar in special directory

#detect libraries
IF (APPLE)
	SET(FOUNDATION_LIBRARIES "-framework Foundation")
ELSEIF (UNIX)
	FIND_PROGRAM(GNUSTEP_CONFIG gnustep-config)
	MESSAGE("Found gnustep-config at: ${GNUSTEP_CONFIG}")
	IF(NOT DEFINED GNUSTEP_CONFIG)
		MESSAGE(FATAL_ERROR "Error: gnustep-config not found. exiting")
	ENDIF()
	EXECUTE_PROCESS(COMMAND ${GNUSTEP_CONFIG} --base-libs  OUTPUT_VARIABLE FOUNDATION_LIBRARIES OUTPUT_STRIP_TRAILING_WHITESPACE)
	EXECUTE_PROCESS(COMMAND ${GNUSTEP_CONFIG} --objc-flags OUTPUT_VARIABLE FOUNDATION_FLAGS OUTPUT_STRIP_TRAILING_WHITESPACE)
	#lets control Optimization and debug on our own please
	STRING(REPLACE "-g -O2" "" FOUNDATION_FLAGS ${FOUNDATION_FLAGS})
	MARK_AS_ADVANCED(GNUSTEP_CONFIG)
ENDIF ()

FIND_PACKAGE(Doxygen)
FIND_PACKAGE(GLUT REQUIRED)
FIND_PACKAGE(OpenGL REQUIRED)
FIND_PACKAGE(ImageMagick COMPONENTS MagickWand REQUIRED)
MARK_AS_ADVANCED(ImageMagick_EXECUTABLE_DIR ImageMagick_MagickWand_INCLUDE_DIR ImageMagick_MagickWand_LIBRARY)
FIND_PACKAGE(PkgConfig)
PKG_CHECK_MODULES(FTGL ftgl)
PKG_CHECK_MODULES(OSMESA osmesa)

FIND_LIBRARY(GENDERS genders)
IF(DEFINED GENDERS)
	SET(HAVE_GENDERS YES)
ENDIF()

SET(CMAKE_REQUIRED_INCLUDES ${ImageMagick_MagickWand_INCLUDE_DIR})
SET(CMAKE_REQUIRED_LIBRARIES ${ImageMagick_MagickWand_LIBRARY})
CHECK_FUNCTION_EXISTS(MagickExportImagePixels HAVE_MAGICKEXPORTIMAGEPIXELS)

FIND_PATH(GL_H_INCLUDE "gl.h" PATH_SUFFIXES GL)
MARK_AS_ADVANCED(GL_H_INCLUDE)

SET(PKG_DATA_DIR "${CMAKE_INSTALL_PREFIX}/share/${PROJECT_NAME}")

IF(DOXYGEN_FOUND AND BUILD_DOCS)
	CONFIGURE_FILE(Doxyfile.in ${CMAKE_BINARY_DIR}/Doxyfile)
	SET(DOXYGEN_OUTPUT ${CMAKE_BINARY_DIR}/html/index.html)
	FILE(GLOB DOXYGEN_INPUT */*.h */*.m */*.c docs/*.dox Doxyfile.in)
	ADD_CUSTOM_COMMAND(OUTPUT ${DOXYGEN_OUTPUT} COMMAND ${DOXYGEN_EXECUTABLE} ${CMAKE_BINARY_DIR}/Doxyfile DEPENDS ${DOXYGEN_INPUT})
	ADD_CUSTOM_TARGET(doc ALL DEPENDS ${DOXYGEN_OUTPUT})
ENDIF()

CONFIGURE_FILE(cview.spec.in ${CMAKE_BINARY_DIR}/cview.spec)
CONFIGURE_FILE(config.h.in ${CMAKE_BINARY_DIR}/config.h)

INCLUDE_DIRECTORIES(${CMAKE_BINARY_DIR})
INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/libcview-data)
INCLUDE_DIRECTORIES(${CMAKE_SOURCE_DIR}/libcview)

ADD_SUBDIRECTORY(libcview-data)
LINK_DIRECTORIES(${CMAKE_BINARY_DIR}/libcview-data)
ADD_SUBDIRECTORY(libcview)
LINK_DIRECTORIES(${CMAKE_BINARY_DIR}/libcview)
#ADD_SUBDIRECTORY(data)
IF (CVIEW_TEST_BUILD)
	ADD_SUBDIRECTORY(tests)
ENDIF()
ADD_SUBDIRECTORY(src)

#this is for in tree testing
FILE(COPY "${CMAKE_SOURCE_DIR}/data" DESTINATION ${CMAKE_BINARY_DIR})

#this is for install
FILE(GLOB DATA_FILES "${CMAKE_SOURCE_DIR}/data/*.ttf*" "${CMAKE_SOURCE_DIR}/data/*.svg" "${CMAKE_SOURCE_DIR}/data/*.ggr")
INSTALL(FILES ${DATA_FILES} DESTINATION "share/${CMAKE_PROJECT_NAME}")  # should we be more specific about which files?

